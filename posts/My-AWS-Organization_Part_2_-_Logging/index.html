<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>My AWS Organization - Part 2 - Bills and Logs | Notepad+++</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="My AWS Organization - Part 2 - Bills and Logs" /><meta name="author" content="remotephone" /><meta property="og:locale" content="en_US" /><meta name="description" content="Part 2 - Some More of the Setup" /><meta property="og:description" content="Part 2 - Some More of the Setup" /><link rel="canonical" href="https://remotephone.github.io/posts/My-AWS-Organization_Part_2_-_Logging/" /><meta property="og:url" content="https://remotephone.github.io/posts/My-AWS-Organization_Part_2_-_Logging/" /><meta property="og:site_name" content="Notepad+++" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-02-10T00:40:00-06:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="My AWS Organization - Part 2 - Bills and Logs" /><meta name="twitter:site" content="@remotephone" /><meta name="twitter:creator" content="@remotephone" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"remotephone"},"description":"Part 2 - Some More of the Setup","@type":"BlogPosting","headline":"My AWS Organization - Part 2 - Bills and Logs","url":"https://remotephone.github.io/posts/My-AWS-Organization_Part_2_-_Logging/","dateModified":"2020-02-10T00:40:00-06:00","datePublished":"2020-02-10T00:40:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://remotephone.github.io/posts/My-AWS-Organization_Part_2_-_Logging/"},"@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"> <!-- CSS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <!-- JS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --> <script src="/assets/js/post.min.js" async></script> <script src="/app.js" defer></script><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@remotephone"><meta name="twitter:title" content="My AWS Organization - Part 2 - Bills and Logs"><meta name="twitter:description" content="My personal blog, mostly security focused."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://remotephone.github.io/images/avatar.jpg"><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/images/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/">Notepad+++</a></div><div class="site-subtitle font-italic">Break it, fix it, write it down.</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/remotephone" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/remotephone" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:window.open('mailto:' + ['remotephone','gmail.com'].join('@'))" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>My AWS Organization - Part 2 - Bills and Logs</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>My AWS Organization - Part 2 - Bills and Logs</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Feb 10, 2020, 12:40 AM -0600" > Feb 10, 2020 <i class="unloaded">2020-02-10T00:40:00-06:00</i> </span> by <span class="author"> remotephone </span></div><div> Updated <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Jul 8, 2022, 10:17 PM -0500" > Jul 8 <i class="unloaded">2022-07-08T22:17:59-05:00</i> </span></div></div><div class="post-content"><h1 id="part-2---some-more-of-the-setup">Part 2 - Some More of the Setup</h1><p>So now we have an account and it’s off to the races right? No! There’s some housekeeping to do first. The most important AWS skill to have is reading your bill. We’ll walk through a bill of mine and how to find out where you’re spending money and then get into logging. After the bill, logging is one of the most important controls you can have in an AWS account. Hopefully you prevent security incidents from happening enforcing strong access controls everywhere, but if you goof, it’s important to know somethings up through the bill and be able to work backwards and fix what happened.</p><p>Once this stuff is set up manually, in the next (weeks??) post I’ll walk through getting some snazzier deployment methods together, focusing on CloudFormation and Terraform and we’ll do the same thing over again but look cooler when we do.</p><h2 id="the-rosetta-stone-of-where-your-money-went">The Rosetta Stone of Where Your Money Went</h2><p>If you’re going to get serious with AWS, you absolutely have to understand your bill. Every month, AWS sends you a bill for everything you spent. Between the first and last day of the month, AWS will track your charges and provide about daily updates of the money you’re spending. Some services will show costs incurred more frequently, but I’ve found it takes about 24 hrs for everything you did to show up in your bill. Being able to read a bill effectively is part art, part science, and part spending way too much money one month and swearing to never do it again.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://remotephone.github.io/images/itsironic.gif" alt="He could save other's money, but not his own" class="center-image" /></p><p>I’ve accidentally spent too much money by doing one or more of the following:</p><ul><li>Leaving Application Load Balancers Running</li><li>Leaving EC2 instances in random regions or accounts running</li><li>Deploying multiple Config rules before prices went down</li><li>Buying more domains than I could possibly use</li></ul><p>Oh yeah, they do charge for access to the AWS Cost Explorer, but I’ve never seen it show up in my bill in a significant way, you’ll probably only see it if you hit the API a ton to generate automated, granular reports, as you can <a href="https://aws.amazon.com/aws-cost-management/pricing/">see here</a>.</p><h2 id="a-guided-tour">A Guided Tour</h2><p>Anyway, you’ll need to be in the root account for this, log in as the IAM User you created and protected with 2FA (you did that, right!?!). Under Services at the top, search Billing and click it to go to the Billing &amp; Cost Management Dashboard. As you can see, I’m going pretty wild.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://remotephone.github.io/images/bigmoney.png" alt="Big Money" class="center-image" /></p><p>Click Cost Explorer and then Monthly Spend by Service View. This won’t be super interesting if you haven’t generated any charges, but you can see in my account a breakdown of money spent by service. The default view is 6 months, but you can toggle timeframes to get much more granular and zero in on what days you generated the most costs.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://remotephone.github.io/images/costsbyservice6month.png" alt="6 month service costs" class="center-image" /></p><p>In the Group By section, you can click other options to find, for example, exactly where you deployed that rogue EC2 instance thats spending your money. This is that console sorted by region, but another very interesting breakdown is by account. This is useful if you launched something in a region or account and forgot to shut it down.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://remotephone.github.io/images/6monthcostbyregion.png" alt="6 month cost by region" class="center-image" /></p><p>Breaking down a single month by day is always interesting too. You can see a spike on the first when recurring services are billed. For me, this is typically hosted zones and domain names in route53.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://remotephone.github.io/images/currentmonthbyday.png" alt="Daily Breakdown" class="center-image" /></p><p>While this was a very quick look into the the AWS Cost Explorer, there is of course <a href="https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/ce-what-is.html">pretty good documentation</a> available straight from AWS themselves. This <a href="https://twitter.com/quinnypig/status/1121140750010527747">fantastic thread</a> from <a href="https://twitter.com/QuinnyPig">@QuinnyPig</a> puts a lot of it into perspective. He generally gives excellent advice about AWS and where all your money went, so follow him.</p><p>Finally, if you find yourself spending more money than you intended to, open a support case with AWS. They have no obligation to forgive your bill, but I’ve been shocked by <a href="https://dev.to/juanmanuelramallo/i-was-billed-for-14k-usd-on-amazon-web-services-17fn">how forgiving</a> they’ve been in the past to other customers who accidentally spent too much.</p><h2 id="why-cloudtrail-matters">Why Cloudtrail Matters</h2><p>Cloudtrail is the bread and butter of AWS Cloud logging. The <a href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-user-guide.html">User Guide</a> is excellent, the <a href="https://aws.amazon.com/cloudtrail/pricing/">Pricing</a> is pretty transparent, and the service is basically free if you’re not doing anything fancy with it. AWS has a great <a href="https://aws.amazon.com/answers/logging/centralized-logging-technical-brief/">brief</a> on the service you should read because it really helps you plan what and how you want to log.</p><p>Cloudtrail tracks all write and most read events in your account. It does not track, by default, AWS S3 access and AWS KMS events unless you explicitly tell it to. You can tell it to focus on a subset of your buckets for read and write events, but you would tend to want to do that if you have very sensitive data in there you need to track access to.</p><p>For my purposes, I run a single organization of about half a dozen accounts I don’t make any money from and don’t have any legal or compliance requirements for. Many of the very excellent <a href="https://www.sumologic.com/insight/aws-log-management-best-practices/">posts</a> about <a href="https://cloudacademy.com/blog/centralized-log-management-with-aws-cloudwatch-part-1-of-3/">logging strategies</a> are great for running an organization for a business, but overkill for my purposes.</p><p>By default, Cloudtrail will track the last 90 days of activity for free, no questions asked. Additionally, those events cannot be deleted. If an attacker takes over your account and wipes out your logging infratructure, you still have 90 days of logs you can work with (Thanks AWS!). To go a bit further, you can tell cloudtrail to log to an S3 bucket.</p><h2 id="a-sample-event">A Sample Event</h2><p>Inside Cloudtrail, you can use the dashboard to view most recent events. One will likely be a Console Login. Interesting parts are the userIdentity.principalId, userIdentity.arn, and userIdentity.userName. userAgent is cool because you can tell what browser they say they’re using and use this for anomaly detection when you get fancier. eventType is interesting too because it tells you what happened.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="p">{</span>
    <span class="dl">"</span><span class="s2">eventVersion</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.05</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">userIdentity</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">IAMUser</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">principalId</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AIDAIXE123456789HQZBA</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">arn</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">arn:aws:iam::111111111111:user/remotephone-admin</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">accountId</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">111111111111</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">userName</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">remotephone-admin</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">eventTime</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2020-02-10T05:11:54Z</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">eventSource</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">signin.amazonaws.com</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">eventName</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ConsoleLogin</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">awsRegion</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">us-east-1</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">sourceIPAddress</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1.2.3.4</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">userAgent</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) snap Chromium/80.0.3987.87 Chrome/80.0.3987.87 Safari/537.36</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">requestParameters</span><span class="dl">"</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">responseElements</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">ConsoleLogin</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Success</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">additionalEventData</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">LoginTo</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://console.aws.amazon.com/console/home?state=hashArgs%23&amp;isauthcode=true</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">MobileVersion</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">No</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">MFAUsed</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Yes</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">eventID</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">f626679f-23e9-42f9-9332-4ee676e5212c</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">eventType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AwsConsoleSignIn</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">recipientAccountId</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">111111111111</span><span class="dl">"</span>
<span class="p">}</span>

</pre></table></code></div></div><p>Sumologic has put out some pretty good <a href="https://www.sumologic.com/blog/aws-cloudtrail-logs/">documentation</a> on what to do with these logs. To jump way ahead, you could read how to use other AWS services, like <a href="https://cloudonaut.io/analyzing-cloudtrail-with-athena/">Athena</a>, to analyze your logs.</p><h2 id="setting-cloudtrail-up">Setting Cloudtrail Up</h2><p>In the Services option at the top, search for Cloudtrail and Click it. One of the most important settings you’ll need to be sure is set is for Cloudtrail to record events from all regions. You’ll also want to record all read and write events.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://remotephone.github.io/images/cloudtrail_new_org.png" alt="cloudtrail New Org" class="center-image" /></p><p>When you create this trail, you can set it to create a new S3 bucket. Handily, AWS handles the S3 bucket permissions for you. You’ll need to pick a bucket name that’s unique for your logging.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://remotephone.github.io/images/cloudtrail_new_org2.png" alt="cloudtrail New Org" class="center-image" /></p><p>I handle an bucket that logs for multiple accounts and haven’t had to manually modify this bucket policy. AWS does all this work for you, you don’t have to worry about it. This is my bucket policy, anonymized because I’m a suspicious person:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="p">{</span>
    <span class="dl">"</span><span class="s2">Version</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2012-10-17</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">Statement</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="dl">"</span><span class="s2">Sid</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AWSCloudTrailAclCheck20150320</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Effect</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Allow</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Principal</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">Service</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cloudtrail.amazonaws.com</span><span class="dl">"</span>
            <span class="p">},</span>
            <span class="dl">"</span><span class="s2">Action</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">s3:GetBucketAcl</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Resource</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">arn:aws:s3:::thisismybucketherearemanylikeit</span><span class="dl">"</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="dl">"</span><span class="s2">Sid</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AWSCloudTrailWrite20150320</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Effect</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Allow</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Principal</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">Service</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cloudtrail.amazonaws.com</span><span class="dl">"</span>
            <span class="p">},</span>
            <span class="dl">"</span><span class="s2">Action</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">s3:PutObject</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Resource</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span>
                <span class="dl">"</span><span class="s2">arn:aws:s3:::thisismybucketherearemanylikeit/AWSLogs/111111111111/*</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">arn:aws:s3:::thisismybucketherearemanylikeit/AWSLogs/222222222222/*</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">arn:aws:s3:::thisismybucketherearemanylikeit/AWSLogs/333333333333/*</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">arn:aws:s3:::thisismybucketherearemanylikeit/AWSLogs/444444444444/*</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">arn:aws:s3:::thisismybucketherearemanylikeit/test/AWSLogs/555555555555/*</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">arn:aws:s3:::thisismybucketherearemanylikeit/test/AWSLogs/666666666666/*</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">arn:aws:s3:::thisismybucketherearemanylikeit/test/AWSLogs/777777777777/*</span><span class="dl">"</span><span class="p">,</span>
                <span class="dl">"</span><span class="s2">arn:aws:s3:::thisismybucketherearemanylikeit/test/AWSLogs/888888888888/*</span><span class="dl">"</span>
            <span class="p">],</span>
            <span class="dl">"</span><span class="s2">Condition</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">StringEquals</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="dl">"</span><span class="s2">s3:x-amz-acl</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bucket-owner-full-control</span><span class="dl">"</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="dl">"</span><span class="s2">Sid</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AWSCloudTrailWrite20150319</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Effect</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Allow</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Principal</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">Service</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">cloudtrail.amazonaws.com</span><span class="dl">"</span>
            <span class="p">},</span>
            <span class="dl">"</span><span class="s2">Action</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">s3:PutObject</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Resource</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">arn:aws:s3:::thisismybucketherearemanylikeit/AWSLogs/o-ws4qczzcuy/*</span><span class="dl">"</span><span class="p">,</span>
            <span class="dl">"</span><span class="s2">Condition</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">StringEquals</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="dl">"</span><span class="s2">s3:x-amz-acl</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">bucket-owner-full-control</span><span class="dl">"</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><p>While this is a policy for an organization with a few accounts in it, you likely won’t see anything this complex. If that bucket policy makes no sense to you whatsoever, we’ll go over that in a different post, but for now you are welcome to start <a href="https://aws.amazon.com/blogs/security/iam-policies-and-bucket-policies-and-acls-oh-my-controlling-access-to-s3-resources/">reading ahead</a>.</p><h2 id="ok-thats-enough">Ok that’s enough</h2><p>It’s getting late. You can read your bill and hopefully know who made it get so big. Next time, I’ll cover creating billing alerts, creating a new account, and really getting your organization off the ground and starting to share things between accounts.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/lab/'>lab</a>, <a href='/categories/homelab/'>homelab</a>, <a href='/categories/aws/'>AWS</a>, <a href='/categories/cloud/'>cloud</a>, <a href='/categories/workflow/'>workflow</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=My AWS Organization - Part 2 - Bills and Logs - Notepad+++&url=https://remotephone.github.io/posts/My-AWS-Organization_Part_2_-_Logging/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=My AWS Organization - Part 2 - Bills and Logs - Notepad+++&u=https://remotephone.github.io/posts/My-AWS-Organization_Part_2_-_Logging/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=My AWS Organization - Part 2 - Bills and Logs - Notepad+++&url=https://remotephone.github.io/posts/My-AWS-Organization_Part_2_-_Logging/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/what-is-markdown/">What is Markdown anyway?</a></li><li><a href="/posts/welcome-to-jekyll/">Welcome to My Scratchpad</a></li><li><a href="/posts/reverse-shell-cheatsheet/">Reverse Shell Cheat Sheet</a></li><li><a href="/posts/practical-docker-part2/">Practical Docker for Security Admins - Part 2</a></li><li><a href="/posts/practical-docker/">Practical Docker for Security Admins - Part 1</a></li></ul></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Recommend the other 3 posts according to the tags and categories of the current post, if the number is not enough, use the other latest posts to supplement. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/My-AWS-Organization/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Jan 20, 2020 <i class="unloaded">2020-01-20T23:28:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>My AWS Organization - Part 1</h3><div class="text-muted small"><p> AWS As Your Home Away From Home Lab I don’t need to tell you the clouds big business and you should know how to work in it. It makes sense to have a place to experiment and test things in, so hope...</p></div></div></a></div><div class="card"> <a href="/posts/My-AWS-Organization_Part_3_-_Billing_Alerts/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Feb 23, 2020 <i class="unloaded">2020-02-23T00:40:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>My AWS Organization - Part 3 - Billing Alerts</h3><div class="text-muted small"><p> Part 3 - Billing Alerts - How You Know You’re In Trouble If you run an AWS Account for long enough, you will inevitably be shocked at how much you accidentally spent one month. For me, it was AWS ...</p></div></div></a></div><div class="card"> <a href="/posts/Proxmox-Greasing-the-Wheels/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Aug 21, 2018 <i class="unloaded">2018-08-21T11:31:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Proxmox - Greasing the Wheels</h3><div class="text-muted small"><p> I got distracted. I’ve done quite a bit of work on the incident response type lab I’ve been working on, but I also got interested in Docker and Docker Swarm. I’ve built that and it works so I figur...</p></div></div></a></div></div></div><!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Messing-Around-With-Memory-Dumps/" class="btn btn-outline-primary"><p>Messing Around with Memory Dumps</p></a> <a href="/posts/My-AWS-Organization_Part_3_-_Billing_Alerts/" class="btn btn-outline-primary"><p>My AWS Organization - Part 3 - Billing Alerts</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/remotephone">remotephone</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a> theme.</p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-158754701-1', 'auto'); ga('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://remotephone.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
