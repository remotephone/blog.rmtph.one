<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Practical Docker for Security Admins - Part 1</title>
  <meta name="description" content="Docker and containers are pretty nifty.  You can run applications or even OSes inside containers (sort of, it shares a kernel with the host OS and there’s st...">

  
  
  <link rel="stylesheet" href="http://localhost:4000/assets/style.css">

  <link rel="canonical" href="http://localhost:4000/lab/homelab/docker/2016/12/20/practical-docker.html">
  <link rel="alternate" type="application/rss+xml" title="Notepad+++" href="http://localhost:4000/feed.xml">

  <script async defer src="https://buttons.github.io/buttons.js"></script>
</head>


  <body>

    <header class="border-bottom-thick px-2 clearfix">
  <div class="left sm-width-full py-1 mt-1 mt-lg-0">
    <a class="align-middle link-primary text-accent" href="/">
      Notepad+++
    </a>
  </div>
  <div class="right sm-width-full">
    <ul class="list-reset mt-lg-1 mb-2 mb-lg-1">
      
        
        <li class="inline-block">
          <a class="align-middle link-primary mr-2 mr-lg-0 ml-lg-2" href="/about/">
            About
          </a>
        </li>
        
      
        
        <li class="inline-block">
          <a class="align-middle link-primary mr-2 mr-lg-0 ml-lg-2" href="/docker/">
            docker
          </a>
        </li>
        
      
        
        <li class="inline-block">
          <a class="align-middle link-primary mr-2 mr-lg-0 ml-lg-2" href="/homelab/">
            homelab
          </a>
        </li>
        
      
        
      
        
        <li class="inline-block">
          <a class="align-middle link-primary mr-2 mr-lg-0 ml-lg-2" href="/proxmox/">
            proxmox
          </a>
        </li>
        
      
        
      
        
        <li class="inline-block">
          <a class="align-middle link-primary mr-2 mr-lg-0 ml-lg-2" href="/workflow/">
            workflow
          </a>
        </li>
        
      
    </ul>
  </div>
</header>


    <div>
      <article class="container px-2 mx-auto mb4" itemscope itemtype="http://schema.org/BlogPosting">
  <h1 class="h0 col-9 sm-width-full py-4 mt-3 inline-block" itemprop="name headline">Practical Docker for Security Admins - Part 1</h1>
  <div class="col-4 sm-width-full mt-1 border-top-thin ">
    <p class="mb-3 py-2 bold h4"><time datetime="2016-12-20T16:29:15-06:00" itemprop="datePublished">Dec 20, 2016</time></p>
  </div>

  <div class="prose" itemprop="articleBody">
      <p><a href="https://www.docker.com/">Docker</a> and containers are pretty nifty.  You can run applications or even OSes inside containers (sort of, it shares a kernel with the host OS and there’s still at least some ways to escape a container to get to the host). The beauty of it to me is how throwaway it is. I saw a presentation where someone started an Ubuntu container, rm -rf /’ed themselves, created a new container, and it was like nothing ever happened. Amazing stuff.</p>

<p>I won’t pretend I’m getting the most possible out of docker or even understand it fully, but the learning curve required to get a whole lot of functionality out of it is really shallow. I have Docker installed in a VM. Like I described earlier, I got it working well enough and then snapshotted it. If you’re not paying attention to what you’re doing, you can run into a lot of errors and annoyances you don’t see coming.</p>

<h2 id="some-use-cases-and-ideas">Some Use Cases and Ideas</h2>

<p>Docker is a really handy way to run things temporarily. There’s an excellent implementation of <a href="https://github.com/citizen-stig/dockermutillidae">Mutillidae</a> that makes for a good test range, base Ubuntu Images, LAMP stacks, and on and on and on.</p>

<p>One of my favorites is <a href="https://www.splunk.com/">Splunk</a>. Sometimes, I’ll get a large amount of logs or data I need to go through quickly. If you’ve never used Splunk, it really is an amazing tool. It indexes data quickly and lets you run very complex searches. The problem is the full version is expensive and the free version has limits. There’s this happy in-between trial enterprise version. You can index a certain amount of data until it warns you, but it won’t stop you. You can ingest several gigabytes of data into a single splunk index, do what you need to do, and then get rid of it. If you’re snapshotting or pausing the container, you can get that data right back without reindexing it. If you forget, just spin up a new container and you’re ready to restart.</p>

<p>Another test case I’m sure has never happened to any incident responder anywhere is that a server becomes ground zero for an incident but it wasn’t logging to a central logging server. Now you have gigabytes of data you need to go through quickly and no way to do it. Splunk can be really useful for situations like these (which probably never happen).</p>

<p>There’s another really interesting project called <a href="https://github.com/gchq/CyberChef.git">CyberChef</a>. Some nice fellow at GCHQ spent their free time building it. I’ll write a post on it later, but the short of it is you can take data, encrypt, decrypt, encode, decode, alter, arrange, whatever it until you have what you want. It’s really an amazing tool.</p>

<p>This post will go into some examples of how to use Docker and cover some pitfalls I’ve run into.</p>

<h3 id="installation">Installation</h3>

<p>There are some pretty good guides to installing Docker out there. There’s the <a href="https://docs.docker.com/engine/installation/linux/ubuntulinux/#/install-the-latest-version">official documentation</a> and <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-16-04">plenty</a> of <a href="https://www.howtoforge.com/tutorial/docker-installation-and-usage-on-ubuntu-16.04/">others</a>. This is the setup that worked for me in November 2016 and still works last I checked a week ago.</p>

<ol>
  <li>
    <p>Install necessary packages</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>docker.io linux-image-extra-<span class="k">$(</span><span class="nb">uname</span> <span class="nt">-r</span><span class="k">)</span> linux-image-extra-virtual git
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add yourself to the appropriate group</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$USER</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Reboot to make sure everything sticks and force you to log back in so group permissions take</p>
  </li>
  <li>
    <p>Log back in and enable the service</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start docker
systemctl <span class="nb">enable </span>docker
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="splunk">Splunk</h3>

<p>Splunk is great Running it in a docker container is greater. I tend to run cheap with VMs and not provision huge drives or anything, so it’s important for me to run them lean. Since my VMs are small and disk space is at a premium, the default minimum free space setting splunk has before it stops indexing of 5GB is pretty greedy for my tastes. I changed up the Dockerfile on the <a href="https://github.com/splunk/docker-splunk">official Splunk repo</a> to require a minimum of 500MB free in my <a href="https://github.com/remotephone/docker-splunk">forked version</a>. I literally changed only one line, so you can just clone the original repo and edit it yourself or just fork mine. The change was on line 42 and 43 of docker-splunk/enterprise/Dockerfile.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>42 &amp;&amp; rm -rf /var/lib/apt/lists/* \
43 &amp;&amp; sed -i -e 's/minFreeSpace = 5000/minFreeSpace = 500/' /var/opt/splunk/etc/system/default/server.conf
</code></pre></div></div>

<p>Replacing the server.conf minFreeSpace variable means indexing will keep running until you have only 500mb free, which is easier to swing than 5GB. If you need to change it further, you can, but at that point its probably better just to make a bigger disk.</p>

<p>For this example, I’ve created a /data directory and copied my VM’s /var/log/ directory into it just so we have some data to work with. To run the image, clone the repo, cd into the enterprise directory and do:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> splunkminfree <span class="nb">.</span>
&lt;<span class="nb">let </span>it run and build&gt;
docker run <span class="nt">-d</span> <span class="nt">-e</span> <span class="s2">"SPLUNK_START_ARGS=--accept-license"</span> <span class="nt">-e</span> <span class="s2">"SPLUNK_USER=root"</span> <span class="nt">-p</span> <span class="s2">"8000:8000"</span>  <span class="nt">-v</span> /data:/root/ splunkminfree
</code></pre></div></div>

<p>If you watch the build happen, you can see where docker replaced the config file as it was building the image.</p>

<p><img src="http://localhost:4000/images/splunksed.png" alt="Splunk Sed Disk Size" class="center-image" /></p>

<p>If you did it right, you’ll have a container available at your VM IP on port 8000. It takes a minute or two to start up and you may have to enable port forwarding if your VM is NATed and not bridged. Once you update the default password, you’re at the start screen!</p>

<p><img src="http://localhost:4000/images/splunkstart.png" alt="Splunk Start Screen" class="center-image" /></p>

<p>If we check our settings page, we can see our sed we did in the Dockerfile took place before execution, so we don’t need to restart the Splunk service, it booted up with our changes in place. This is important because if you do your changes as part of the entrypoint.sh script or elsewhere that’s not in the Dockerfile, your container can start up services before changes are made, making you restart them to get where you wanted to be to begin with.</p>

<p><img src="http://localhost:4000/images/splunksettings.png" alt="Splunk Settings" class="center-image" /></p>

<p>So now we have a working splunk instance, it loaded data at /data, and we can search it. You can change the destination mount directory to whatever you want, but since I sent it to the root user’s home folder, I need to find it  there.</p>

<p><img src="http://localhost:4000/images/splunkdatadirs.png" alt="Splunk Settings" class="center-image" /></p>

<p>Indexing will take a little bit depending on how much data you have, but there it is! You can now do all the wonderful things you can usually do in Splunk.</p>

<p>I think that’s all I want to go over for now. I’ll do a part 2 on this soon and go over Cyberchef.</p>

  </div>

</article>

<div class="container mx-auto px-2 py-2 clearfix">
  <!-- Use if you want to show previous and next for all posts. -->



  <div class="col-4 sm-width-full left mr-lg-4 mt-3">
    <a class="no-underline border-top-thin py-1 block" href="http://localhost:4000/lab/homelab/budget/testing/2016/12/20/Lab_on_a_budget.html">
      <span class="h5 bold text-accent">Previous</span>
      <p class="bold h3 link-primary mb-1">Security Labs on a (no) budget</p>
      <p>So you want a lab? It’s going to cost money. You can’t do this for free. Luckily, you’ve probably spent...</p>
    </a>
  </div>
  
  
  <div class="col-4 sm-width-full left mt-3">
    <a class="no-underline border-top-thin py-1 block" href="http://localhost:4000/lab/homelab/docker/2016/12/26/practical-docker-part2.html">
      <span class="h5 bold text-accent">Next</span>
      <p class="bold h3 link-primary mb-1">Practical Docker for Security Admins - Part 2</p>
      <p>## More test cases, but first, some housekeeping Docker will fill up disk space quickly if you're not managing it...</p>
    </a>
  </div>


</div>

    </div>

    <div class="border-top-thin clearfix mt-2 mt-lg-4">
  <div class="container mx-auto px-2">
    <p class="col-8 sm-width-full left py-2 mb-0">This project is maintained by <a class="text-accent" href="https://github.com/remotephone">remotephone</a></p>
    <ul class="list-reset right clearfix sm-width-full py-2 mb-2 mb-lg-0">
      <li class="inline-block mr-1">
        <a href="https://twitter.com/share" class="twitter-share-button" data-hashtags="Notepad+++">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
      </li>
      <li class="inline-block">
        <a class="github-button" href="https://github.com/remotephone/remotephone.github.io" data-icon="octicon-star" data-count-href="remotephone//stargazers" data-count-api="/repos/remotephone/#stargazers_count" data-count-aria-label="# stargazers on GitHub" aria-label="Star remotephone/ on GitHub">Star</a>
      </li>
    </ul>
  </div>
</div>


  </body>

</html>
